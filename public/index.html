<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PREPARACION OPOSICION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #fef7f0;
            min-height: 100vh;
            color: #374151;
            line-height: 1.6;
            font-weight: 400;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            color: #6b7280;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
            color: #374151;
        }

        .header p {
            font-size: 1.1rem;
            color: #9ca3af;
            font-weight: 300;
        }

        /* NAVEGACI√ìN PRINCIPAL */
        .main-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .nav-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .nav-button.active {
            background: #f97316;
            color: white;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        }

        .nav-button:hover:not(.active) {
            background: #f9fafb;
            color: #374151;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 32px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 12px;
            color: #374151;
        }

        .select-wrapper {
            position: relative;
        }

        .form-select {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            background: #fafafa;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 16px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
        }

        .form-select:focus {
            outline: none;
            border-color: #f97316;
            background: white;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .start-button, .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.025em;
        }

        .start-button:hover:not(:disabled), .btn-primary:hover {
            background: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }

        .start-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        /* P√ÅGINAS */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ESTILOS DE LA PREGUNTA */
        .question-header {
            background: #f97316;
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            text-align: center;
        }

        .question-header h2 {
            font-size: 1.25rem;
            font-weight: 500;
        }

        .question-card {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
            border-top: none;
        }

        .question-text {
            font-size: 1.125rem;
            color: #1f2937;
            margin-bottom: 32px;
            line-height: 1.7;
            font-weight: 400;
        }

        .option {
            display: flex;
            align-items: flex-start;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
        }

        .option:hover {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.1);
        }

        .option.selected {
            border-color: #f97316;
            background: #fff7ed;
        }

        .option.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .option.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .option input[type="radio"] {
            margin-right: 16px;
            margin-top: 2px;
            transform: scale(1.1);
            accent-color: #f97316;
        }

        .option-text {
            flex: 1;
            line-height: 1.6;
            font-size: 1rem;
            color: #374151;
        }

        .result-section {
            margin-top: 32px;
            padding: 24px;
            border-radius: 12px;
            display: none;
        }

        .result-section.correct {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .result-section.incorrect {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .result-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .result-explanation {
            font-size: 1rem;
            line-height: 1.6;
            color: #4b5563;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.025em;
        }

        .btn-secondary {
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        /* NOTIFICACIONES DE RETRY */
        .retry-notification {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .retry-notification.active {
            display: flex;
        }

        .retry-notification .icon {
            font-size: 1.5rem;
        }

        .retry-notification .content {
            flex: 1;
        }

        .retry-notification .title {
            font-weight: 600;
            color: #d97706;
            margin-bottom: 4px;
        }

        .retry-notification .message {
            color: #92400e;
            font-size: 0.875rem;
        }

        .retry-progress {
            width: 100%;
            height: 4px;
            background: #fde68a;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .retry-progress-bar {
            height: 100%;
            background: #f59e0b;
            width: 0%;
            transition: width 0.1s ease;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ESTAD√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .stat-badge {
            background: #f97316;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .stat-badge.good {
            background: #10b981;
        }

        .stat-badge.warning {
            background: #f59e0b;
        }

        .stat-badge.danger {
            background: #ef4444;
        }

        .stat-numbers {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }

        .stat-number {
            text-align: center;
        }

        .stat-number .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-number .label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .progress-bar {
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #f97316;
            transition: width 0.3s ease;
        }

        .progress-fill.good {
            background: #10b981;
        }

        .progress-fill.warning {
            background: #f59e0b;
        }

        .progress-fill.danger {
            background: #ef4444;
        }

        .last-studied {
            font-size: 0.875rem;
            color: #9ca3af;
            text-align: center;
        }

        /* PREGUNTAS FALLADAS */
        .failed-topics {
            margin-top: 24px;
        }

        .failed-topic {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .failed-topic-header {
            background: #fef2f2;
            padding: 20px;
            border-bottom: 1px solid #fecaca;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .failed-topic-header:hover {
            background: #fde8e8;
        }

        .failed-topic-header h3 {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .failed-topic-count {
            color: #ef4444;
            font-size: 0.875rem;
        }

        .failed-questions {
            padding: 20px;
            display: none;
        }

        .failed-questions.active {
            display: block;
        }

        .failed-question {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafafa;
        }

        .failed-question-text {
            font-weight: 500;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .failed-question-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .retry-button {
            background: #f97316;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retry-button:hover {
            background: #ea580c;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #fecaca;
            text-align: center;
            font-size: 0.875rem;
        }

        .success-message {
            background: #f0fdf4;
            color: #16a34a;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #bbf7d0;
            text-align: center;
            font-size: 0.875rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state .emoji {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        .emoji {
            font-size: 1.5rem;
            margin-right: 8px;
        }

        /* ESTADO DE SERVIDOR */
        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .server-status.online {
            background: #dcfce7;
            color: #166534;
        }

        .server-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* AUTENTICACI√ìN */
        .auth-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fef7f0;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-screen.active {
            display: flex;
        }

        .auth-container {
            max-width: 440px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            padding: 48px 40px;
            border: 1px solid #f3f4f6;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: #9ca3af;
            font-size: 1rem;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: #f9fafb;
            padding: 4px;
            border-radius: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .auth-tab.active {
            background: white;
            color: #f97316;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 8px;
            color: #374151;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: #fafafa;
            color: #374151;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #f97316;
            background: white;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .auth-button {
            width: 100%;
            padding: 14px 20px;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .auth-button:hover:not(:disabled) {
            background: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .auth-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .auth-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.875rem;
            text-align: center;
            display: none;
        }

        .auth-message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }

        .auth-message.success {
            background: #f0fdf4;
            color: #065f46;
            border: 1px solid #bbf7d0;
            display: block;
        }

        .auth-message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
            display: block;
        }

        .logout-button {
            position: absolute;
            top: 24px;
            right: 24px;
            padding: 8px 16px;
            background: #f9fafb;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-button:hover {
            background: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }

        .user-info {
            display: inline-block;
            padding: 6px 12px;
            background: #fff7ed;
            color: #f97316;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: 12px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 16px;
            }

            .card {
                padding: 24px;
            }

            .action-buttons, .main-nav {
                flex-direction: column;
            }

            .question-card {
                padding: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-numbers {
                gap: 16px;
            }

            .auth-container {
                padding: 32px 24px;
            }

            .logout-button {
                position: static;
                margin-top: 16px;
                width: 100%;
            }
        }

        /* ESTILOS PARA EXAMEN OFICIAL */
        .exam-size-btn,
        .exam-time-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }

        .exam-size-btn:hover,
        .exam-time-btn:hover {
            border-color: #f97316;
            background: #fff7ed;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
        }

        .exam-size-btn.active,
        .exam-time-btn.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-color: #f97316;
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        #official-exam-timer {
            position: fixed;
            top: 80px;
            right: 24px;
            background: white;
            border: 2px solid #f97316;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        #official-exam-timer.warning {
            background: #fef3c7;
            border-color: #fbbf24;
            animation: pulse 1s infinite;
        }

        #official-exam-timer.danger {
            background: #fee2e2;
            border-color: #dc2626;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE AUTENTICACI√ìN -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üìö Oposiciones</h1>
                <p>Accede a tu cuenta para estudiar</p>
            </div>

            <div id="auth-message" class="auth-message"></div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')" id="tab-login">
                    Iniciar Sesi√≥n
                </button>
                <button class="auth-tab" onclick="switchAuthTab('register')" id="tab-register">
                    Registrarse
                </button>
            </div>

            <!-- FORMULARIO DE LOGIN -->
            <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="auth-input-group">
                    <label for="login-username">Usuario</label>
                    <input
                        type="text"
                        id="login-username"
                        class="auth-input"
                        placeholder="Ingresa tu usuario"
                        required
                        autocomplete="username"
                    >
                </div>
                <div class="auth-input-group">
                    <label for="login-password">Contrase√±a</label>
                    <input
                        type="password"
                        id="login-password"
                        class="auth-input"
                        placeholder="Ingresa tu contrase√±a"
                        required
                        autocomplete="current-password"
                    >
                </div>
                <button type="submit" class="auth-button" id="login-btn">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <!-- FORMULARIO DE REGISTRO -->
            <form id="register-form" class="auth-form" onsubmit="handleRegister(event)">
                <div class="auth-input-group">
                    <label for="register-username">Usuario</label>
                    <input
                        type="text"
                        id="register-username"
                        class="auth-input"
                        placeholder="Elige un usuario (m√≠n. 3 caracteres)"
                        minlength="3"
                        required
                        autocomplete="username"
                    >
                </div>
                <div class="auth-input-group">
                    <label for="register-password">Contrase√±a</label>
                    <input
                        type="password"
                        id="register-password"
                        class="auth-input"
                        placeholder="Elige una contrase√±a (m√≠n. 6 caracteres)"
                        minlength="6"
                        required
                        autocomplete="new-password"
                    >
                </div>
                <div class="auth-input-group">
                    <label for="register-password-confirm">Confirmar Contrase√±a</label>
                    <input
                        type="password"
                        id="register-password-confirm"
                        class="auth-input"
                        placeholder="Repite tu contrase√±a"
                        minlength="6"
                        required
                        autocomplete="new-password"
                    >
                </div>
                <button type="submit" class="auth-button" id="register-btn">
                    Crear Cuenta
                </button>
                <p style="margin-top: 16px; font-size: 0.875rem; color: #6b7280; text-align: center;">
                    Tu cuenta quedar√° bloqueada hasta que el administrador la active.
                </p>
            </form>
        </div>
    </div>

    <div class="container" id="main-app" style="display: none;">
        <button class="logout-button" onclick="handleLogout()" id="logout-btn" style="display: none;">
            üö™ Cerrar Sesi√≥n
        </button>

        <div class="header">
            <h1>
                <span class="emoji">üìö</span>Preparaci√≥n Oposici√≥n
                <span id="user-info" class="user-info" style="display: none;"></span>
            </h1>
            <p>Sistema de estudio inteligente</p>
            <div id="server-status" class="server-status offline">
                <div class="status-indicator"></div>
                <span>Verificando servidor...</span>
            </div>
        </div>

        <!-- NAVEGACI√ìN PRINCIPAL -->
        <nav class="main-nav">
            <button class="nav-button active" onclick="showPage('study')" id="nav-study">
                üìù Estudiar
            </button>
            <button class="nav-button" onclick="showPage('progress')" id="nav-progress">
                üìä Ver Avance
            </button>
            <button class="nav-button" onclick="showPage('review')" id="nav-review">
                üîÑ Reforzar
            </button>
            <button class="nav-button" onclick="showPage('official-exam')" id="nav-official-exam">
                üéì Examen Oficial
            </button>
        </nav>

        <!-- NOTIFICACI√ìN DE REINTENTOS -->
        <div id="retry-notification" class="retry-notification">
            <div class="icon">üîÑ</div>
            <div class="content">
                <div class="title">Reintentando generar pregunta...</div>
                <div class="message" id="retry-message">Claude est√° temporalmente ocupado. La aplicaci√≥n reintentar√° autom√°ticamente.</div>
                <div class="retry-progress">
                    <div class="retry-progress-bar" id="retry-progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- TEMPORIZADOR EXAMEN OFICIAL -->
        <div id="official-exam-timer">
            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px; text-align: center;">‚è±Ô∏è Tiempo Restante</div>
            <div id="timer-display" style="font-size: 1.5rem; font-weight: bold; text-align: center;">60:00</div>
        </div>

        <!-- P√ÅGINA DE ESTUDIO -->
        <div id="study-page" class="page active">
            <!-- SELECCI√ìN DE TEMA -->
            <div id="topic-selection" class="card">
                <div class="form-group">
                    <label for="topic-select">Selecciona un tema para estudiar</label>
                    <div class="select-wrapper">
                        <select id="topic-select" class="form-select">
                            <option value="">Cargando temas disponibles...</option>
                        </select>
                    </div>
                </div>

                <button class="start-button" onclick="startStudying()" id="start-btn" disabled>
                    Comenzar a estudiar
                </button>
                
                <div id="error-container"></div>
            </div>

            <div class="card" id="available-topics">
                <p>Cargando informaci√≥n de temas...</p>
            </div>

            <!-- PREGUNTA -->
            <div id="question-container" class="hidden">
                <div class="question-header">
                    <div id="current-topic-name">Tema Actual</div>
                    <div id="question-number">Pregunta 1</div>
                </div>

                <div class="question-card">
                    <div class="question-text" id="question-text">
                        Cargando pregunta...
                    </div>
                    
                    <div id="options-container">
                        <!-- Las opciones se cargar√°n aqu√≠ -->
                    </div>
                    
                    <div class="result-section" id="result-section">
                        <div class="result-icon" id="result-icon"></div>
                        <div class="result-title" id="result-title"></div>
                        <div class="result-explanation" id="result-explanation"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="backToTopicSelection()">
                            <span class="emoji">üè†</span> Volver al inicio
                        </button>
                        <button class="btn btn-primary" id="next-question-btn" onclick="generateNextQuestion()" style="display: none;">
                            Siguiente pregunta <span class="emoji">‚Üí</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA DE PROGRESO -->
        <div id="progress-page" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2><span class="emoji">üìä</span>Tu Progreso de Estudio</h2>
                    <button onclick="clearAllData()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                        üóëÔ∏è Limpiar datos
                    </button>
                </div>
                <p style="color: #6b7280; margin-top: 8px;">Revisa tu rendimiento en cada tema</p>
            </div>

            <div id="stats-container">
                <div class="empty-state">
                    <div class="emoji">üìà</div>
                    <h3>¬°Comienza a estudiar!</h3>
                    <p>Aqu√≠ ver√°s tus estad√≠sticas una vez que respondas algunas preguntas.</p>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA DE REPASO -->
        <div id="review-page" class="page">
            <div class="card">
                <h2><span class="emoji">üîÑ</span>Refuerza tus Conocimientos</h2>
                <p style="color: #6b7280; margin-top: 8px;">Repasa las preguntas que has fallado</p>
            </div>

            <div id="failed-container">
                <div class="empty-state">
                    <div class="emoji">üéØ</div>
                    <h3>¬°Excelente!</h3>
                    <p>No tienes preguntas falladas para repasar. Sigue practicando para mantener tu nivel.</p>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA: EXAMEN OFICIAL -->
        <div id="official-exam-page" class="page">
            <div class="card">
                <h2><span class="emoji">üéì</span>Examen Oficial Simulacro</h2>
                <p style="color: #6b7280; margin-top: 8px;">Pon a prueba tus conocimientos con un examen completo como el real</p>
            </div>

            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 16px; color: #1f2937;">‚öôÔ∏è Configurar Examen</h3>

                <!-- Selector de Preguntas -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #374151;">
                        üìù N√∫mero de Preguntas
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <button class="exam-size-btn active" data-size="25" onclick="selectExamSize(25)">
                            <div style="font-size: 1.5rem; font-weight: bold;">25</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">R√°pido</div>
                        </button>
                        <button class="exam-size-btn" data-size="50" onclick="selectExamSize(50)">
                            <div style="font-size: 1.5rem; font-weight: bold;">50</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Medio</div>
                        </button>
                        <button class="exam-size-btn" data-size="75" onclick="selectExamSize(75)">
                            <div style="font-size: 1.5rem; font-weight: bold;">75</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Largo</div>
                        </button>
                        <button class="exam-size-btn" data-size="100" onclick="selectExamSize(100)">
                            <div style="font-size: 1.5rem; font-weight: bold;">100</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Completo</div>
                        </button>
                    </div>
                </div>

                <!-- Selector de Tiempo -->
                <div style="margin-bottom: 32px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #374151;">
                        ‚è±Ô∏è Tiempo L√≠mite
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <button class="exam-time-btn active" data-time="30" onclick="selectExamTime(30)">
                            <div style="font-size: 1.25rem; font-weight: bold;">30</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">minutos</div>
                        </button>
                        <button class="exam-time-btn" data-time="60" onclick="selectExamTime(60)">
                            <div style="font-size: 1.25rem; font-weight: bold;">60</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">minutos</div>
                        </button>
                        <button class="exam-time-btn" data-time="90" onclick="selectExamTime(90)">
                            <div style="font-size: 1.25rem; font-weight: bold;">90</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">minutos</div>
                        </button>
                        <button class="exam-time-btn" data-time="120" onclick="selectExamTime(120)">
                            <div style="font-size: 1.25rem; font-weight: bold;">120</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">minutos</div>
                        </button>
                    </div>
                </div>

                <!-- Informaci√≥n del Examen -->
                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Modo Examen Real</div>
                            <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 0.875rem; line-height: 1.6;">
                                <li>Preguntas mezcladas de <strong>todos los temas</strong></li>
                                <li>No podr√°s volver a preguntas anteriores</li>
                                <li>El temporizador ser√° visible en todo momento</li>
                                <li>Se guardar√° tu puntuaci√≥n al finalizar</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Iniciar -->
                <button onclick="startOfficialExam()" style="width: 100%; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 16px 32px; font-size: 1.125rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(249, 115, 22, 0.4)';" onmouseout="this.style.transform='none'; this.style.boxShadow='0 4px 12px rgba(249, 115, 22, 0.3)';">
                    üöÄ Iniciar Examen Oficial
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTopic = null;
        let currentQuestion = null;
        let questionCount = 0;
        let correctAnswers = 0;
        let availableTopics = [];
        let userStats = {};
        let failedQuestions = {};
        let isServerOnline = false;
        let retryAttempt = 0;
        let maxRetryAttempts = 3;
        const API_BASE = '';
        let currentUser = null;
        let isAuthenticated = false;

        // Variables para Examen Oficial
        let officialExamConfig = {
            questionCount: 25,
            timeLimit: 30 // minutos
        };
        let officialExamQuestions = [];
        let officialExamTimer = null;
        let officialExamTimeRemaining = 0; // segundos
        let isOfficialExamMode = false;
        let officialExamStartTime = null;
        let officialExamAnswers = [];

        // ========================
        // SISTEMA DE AUTENTICACI√ìN
        // ========================

        async function checkAuth() {
            console.log('üîê Verificando autenticaci√≥n...');
            try {
                const response = await fetch(`${API_BASE}/api/auth/check`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('üì° Respuesta auth/check:', {
                    status: response.status,
                    ok: response.ok
                });

                const data = await response.json();
                console.log('üì¶ Datos de autenticaci√≥n:', data);

                if (data.authenticated) {
                    if (data.blocked) {
                        console.warn('‚ö†Ô∏è Usuario bloqueado');
                        showAuthScreen();
                        showAuthMessage('error', 'Tu cuenta est√° bloqueada. Contacta al administrador para reactivarla.');
                        return false;
                    }

                    isAuthenticated = true;
                    currentUser = data.user;
                    console.log('‚úÖ Usuario autenticado:', currentUser);
                    showMainApp();
                    return true;
                } else {
                    console.log('‚ùå No autenticado');
                    showAuthScreen();
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error verificando autenticaci√≥n:', error);
                showAuthScreen();
                return false;
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.getElementById('tab-login').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.getElementById('tab-register').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }

            // Limpiar mensajes
            showAuthMessage();
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');

            btn.disabled = true;
            btn.textContent = 'Iniciando sesi√≥n...';

            console.log('üîë Intentando login con usuario:', username);

            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('üì° Respuesta login:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                const data = await response.json();
                console.log('üì¶ Datos login:', data);

                if (response.ok) {
                    console.log('‚úÖ Login exitoso!');
                    currentUser = data.user;
                    isAuthenticated = true;
                    showMainApp();

                    // Cargar datos del usuario desde el servidor
                    await loadUserData();

                    // IMPORTANTE: Verificar servidor despu√©s de login
                    await checkServerHealth();
                    await loadAvailableTopics();
                } else {
                    console.error('‚ùå Login fall√≥:', data.error);
                    showAuthMessage('error', data.error || 'Error al iniciar sesi√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error en login (excepci√≥n):', error);
                showAuthMessage('error', 'Error de conexi√≥n. Intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesi√≥n';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const btn = document.getElementById('register-btn');

            if (password !== passwordConfirm) {
                showAuthMessage('error', 'Las contrase√±as no coinciden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creando cuenta...';

            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.requiresActivation) {
                        showAuthMessage('warning', 'Cuenta creada. Espera a que el administrador la active para poder acceder.');
                        // Cambiar a tab de login despu√©s de 3 segundos
                        setTimeout(() => {
                            switchAuthTab('login');
                        }, 3000);
                    } else {
                        showAuthMessage('success', 'Cuenta creada exitosamente');
                    }

                    // Limpiar formulario
                    document.getElementById('register-form').reset();
                } else {
                    showAuthMessage('error', data.error || 'Error al crear cuenta');
                }
            } catch (error) {
                console.error('Error en registro:', error);
                showAuthMessage('error', 'Error de conexi√≥n. Intenta de nuevo.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Crear Cuenta';
            }
        }

        async function handleLogout() {
            if (!confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                return;
            }

            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                isAuthenticated = false;
                currentUser = null;
                userStats = {};
                failedQuestions = {};

                showAuthScreen();
                showAuthMessage('success', 'Sesi√≥n cerrada correctamente');
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        }

        function showAuthScreen() {
            document.getElementById('auth-screen').classList.add('active');
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('user-info').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('auth-screen').classList.remove('active');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'block';

            if (currentUser) {
                const userInfoElement = document.getElementById('user-info');
                userInfoElement.textContent = currentUser.username;
                userInfoElement.style.display = 'inline-block';
            }
        }

        function showAuthMessage(type, message) {
            const messageElement = document.getElementById('auth-message');

            if (!type || !message) {
                messageElement.className = 'auth-message';
                messageElement.textContent = '';
                return;
            }

            messageElement.className = `auth-message ${type}`;
            messageElement.textContent = message;
        }

        async function loadUserData() {
            try {
                // Cargar estad√≠sticas del usuario desde el servidor
                const statsResponse = await fetch(`${API_BASE}/api/user-stats`, {
                    credentials: 'include'
                });

                if (statsResponse.ok) {
                    userStats = await statsResponse.json();
                    displayStats();
                }

                // Cargar preguntas falladas del usuario desde el servidor
                const failedResponse = await fetch(`${API_BASE}/api/failed-questions`, {
                    credentials: 'include'
                });

                if (failedResponse.ok) {
                    failedQuestions = await failedResponse.json();
                    displayFailedQuestions();
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
            }
        }

        // ========================
        // VERIFICACI√ìN DEL SERVIDOR
        // ========================

        async function checkServerHealth() {
            console.log('üîç Verificando servidor...');
            updateServerStatus('checking', 'Verificando servidor...');

            try {
                const response = await fetch(`${API_BASE}/api/health`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('üì° Respuesta del servidor:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                if (response.ok) {
                    const health = await response.json();
                    updateServerStatus('online', 'Servidor en l√≠nea');
                    isServerOnline = true;
                    console.log('‚úÖ Servidor disponible:', health);
                    return true;
                } else {
                    console.error('‚ùå Respuesta no OK:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('‚ùå Error conectando al servidor:', error);
                console.error('Error completo:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }

            updateServerStatus('offline', 'Modo demostraci√≥n');
            isServerOnline = false;
            return false;
        }

        function updateServerStatus(status, message) {
            const statusElement = document.getElementById('server-status');
            statusElement.className = `server-status ${status}`;
            statusElement.innerHTML = `
                <div class="status-indicator"></div>
                <span>${message}</span>
            `;
        }

        // ========================
        // SISTEMA DE REINTENTOS
        // ========================

        function showRetryNotification(attempt, maxAttempts, message) {
            const notification = document.getElementById('retry-notification');
            const messageElement = document.getElementById('retry-message');
            const progressBar = document.getElementById('retry-progress-bar');
            
            notification.classList.add('active');
            messageElement.textContent = `${message} (Intento ${attempt}/${maxAttempts})`;
            
            const progressPercentage = (attempt / maxAttempts) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function hideRetryNotification() {
            const notification = document.getElementById('retry-notification');
            notification.classList.remove('active');
            retryAttempt = 0;
        }

        async function generateQuestionWithRetry() {
            retryAttempt = 0;
            
            while (retryAttempt < maxRetryAttempts) {
                retryAttempt++;
                
                if (retryAttempt > 1) {
                    showRetryNotification(retryAttempt, maxRetryAttempts, 'Reintentando...');
                    const waitTime = Math.min(2000 * Math.pow(2, retryAttempt - 2), 10000);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/generate-exam`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            topics: [currentTopic],
                            questionCount: 1
                        }),
                    });

                    if (response.status === 401 || response.status === 403) {
                        // Sesi√≥n expirada o cuenta bloqueada
                        isAuthenticated = false;
                        currentUser = null;
                        showAuthScreen();
                        const errorData = await response.json();
                        showAuthMessage('error', errorData.error || 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                        return false;
                    }

                    if (response.ok) {
                        const data = await response.json();

                        if (data.questions && data.questions.length > 0) {
                            currentQuestion = data.questions[0];
                            hideRetryNotification();
                            displayQuestion();
                            return true;
                        }
                    } else if (response.status === 503 || response.status === 429) {
                        const errorData = await response.json();
                        console.log(`‚è≥ Error ${response.status}: ${errorData.error}`);

                        if (retryAttempt < maxRetryAttempts) {
                            showRetryNotification(retryAttempt, maxRetryAttempts, errorData.error || 'Servidor ocupado');
                            continue;
                        }
                    } else {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error(`‚ùå Intento ${retryAttempt} fallido:`, error);
                    
                    if (retryAttempt < maxRetryAttempts) {
                        showRetryNotification(retryAttempt, maxRetryAttempts, 'Error de conexi√≥n');
                        continue;
                    }
                }
            }
            
            hideRetryNotification();
            showDemoQuestion();
            showError('No se pudo conectar. Mostrando pregunta de demostraci√≥n.');
            return false;
        }

        // ========================
        // PERSISTENCIA DE DATOS
        // ========================

        function saveUserStats() {
            try {
                localStorage.setItem('oposicion_stats', JSON.stringify(userStats));
                console.log('üìä Estad√≠sticas guardadas');
            } catch (error) {
                console.error('Error guardando estad√≠sticas:', error);
            }
        }

        function loadUserStatsFromLocal() {
            try {
                const saved = localStorage.getItem('oposicion_stats');
                if (saved) {
                    userStats = JSON.parse(saved);
                    console.log('üìä Estad√≠sticas cargadas');
                } else {
                    userStats = {};
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                userStats = {};
            }
        }

        function saveFailedQuestions() {
            try {
                localStorage.setItem('oposicion_failed', JSON.stringify(failedQuestions));
                console.log('‚ùå Preguntas falladas guardadas');
            } catch (error) {
                console.error('Error guardando preguntas falladas:', error);
            }
        }

        function loadFailedQuestionsFromLocal() {
            try {
                const saved = localStorage.getItem('oposicion_failed');
                if (saved) {
                    failedQuestions = JSON.parse(saved);
                    console.log('‚ùå Preguntas falladas cargadas');
                } else {
                    failedQuestions = {};
                }
            } catch (error) {
                console.error('Error cargando preguntas falladas:', error);
                failedQuestions = {};
            }
        }

        async function updateLocalStats(topicId, isCorrect, isReview = false, questionId = null) {
            const topicConfig = availableTopics.find(([id]) => id === topicId);
            const topicTitle = topicConfig ? topicConfig[1].title : 'Tema desconocido';

            // Si es modo repaso, no actualizar estad√≠sticas locales
            if (!isReview) {
                if (!userStats[topicId]) {
                    userStats[topicId] = {
                        title: topicTitle,
                        totalQuestions: 0,
                        correctAnswers: 0,
                        lastStudied: new Date().toISOString()
                    };
                }

                userStats[topicId].totalQuestions++;
                if (isCorrect) {
                    userStats[topicId].correctAnswers++;
                }
                userStats[topicId].lastStudied = new Date().toISOString();
                userStats[topicId].accuracy = Math.round((userStats[topicId].correctAnswers / userStats[topicId].totalQuestions) * 100);
            }

            // Enviar al servidor
            try {
                const requestBody = {
                    topicId,
                    questionData: currentQuestion,
                    userAnswer: null,
                    isCorrect
                };

                // Agregar par√°metros de repaso si aplica
                if (isReview && questionId) {
                    requestBody.isReview = true;
                    requestBody.questionId = questionId;
                }

                const response = await fetch(`${API_BASE}/api/record-answer`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                }

                if (response.ok) {
                    console.log(isReview ? '‚úÖ Pregunta de repaso procesada' : '‚úÖ Estad√≠sticas guardadas en servidor');

                    // Si es repaso y fue correcta, actualizar la lista local
                    if (isReview && isCorrect && questionId) {
                        if (failedQuestions[topicId]) {
                            failedQuestions[topicId].questions = failedQuestions[topicId].questions.filter(q => q.id !== questionId);
                            if (failedQuestions[topicId].questions.length === 0) {
                                delete failedQuestions[topicId];
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error guardando datos:', error);
            }
        }

        async function addLocalFailedQuestion(topicId, questionData, userAnswer) {
            const topicConfig = availableTopics.find(([id]) => id === topicId);
            const topicTitle = topicConfig ? topicConfig[1].title : 'Tema desconocido';

            // Actualizar localmente primero
            if (!failedQuestions[topicId]) {
                failedQuestions[topicId] = {
                    title: topicTitle,
                    questions: []
                };
            }

            const failedQuestion = {
                ...questionData,
                userAnswer,
                date: new Date().toISOString(),
                id: Date.now() + Math.random()
            };

            failedQuestions[topicId].questions.push(failedQuestion);

            // Enviar al servidor
            try {
                const response = await fetch(`${API_BASE}/api/record-answer`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topicId,
                        questionData,
                        userAnswer,
                        isCorrect: false
                    })
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                }

                if (response.ok) {
                    console.log('‚úÖ Pregunta fallada guardada en servidor');
                }
            } catch (error) {
                console.error('Error guardando pregunta fallada:', error);
            }
        }

        async function removeLocalFailedQuestion(topicId, questionId) {
            // Actualizar localmente primero
            if (failedQuestions[topicId]) {
                failedQuestions[topicId].questions = failedQuestions[topicId].questions.filter(q => q.id !== questionId);

                if (failedQuestions[topicId].questions.length === 0) {
                    delete failedQuestions[topicId];
                }
            }

            // Enviar al servidor
            try {
                const response = await fetch(`${API_BASE}/api/resolve-failed-question`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionId })
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                }

                if (response.ok) {
                    console.log('‚úÖ Pregunta resuelta guardada en servidor');
                }
            } catch (error) {
                console.error('Error marcando pregunta como repasada:', error);
            }
        }

        // ========================
        // NAVEGACI√ìN
        // ========================

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`${pageName}-page`).classList.add('active');
            document.getElementById(`nav-${pageName}`).classList.add('active');
            
            switch(pageName) {
                case 'study':
                    loadAvailableTopics();
                    break;
                case 'progress':
                    displayStats();
                    break;
                case 'review':
                    displayFailedQuestions();
                    break;
            }
        }

        function showQuestionMode() {
            document.getElementById('topic-selection').style.display = 'none';
            document.getElementById('available-topics').style.display = 'none';
            document.getElementById('question-container').classList.remove('hidden');
        }

        async function backToTopicSelection() {
            document.getElementById('topic-selection').style.display = 'block';
            document.getElementById('available-topics').style.display = 'block';
            document.getElementById('question-container').classList.add('hidden');
            hideRetryNotification();

            // Si est√°bamos en modo repaso, recargar preguntas falladas
            const wasReviewMode = window.isReviewMode === true;

            // Salir del modo repaso si estaba activo
            window.isReviewMode = false;
            window.reviewQuestions = null;
            window.currentReviewIndex = 0;

            // Recargar datos del usuario si ven√≠amos de modo repaso
            if (wasReviewMode) {
                await loadUserData();
            }

            loadAvailableTopics();
        }

        // ========================
        // CARGA DE TEMAS
        // ========================

        async function loadAvailableTopics() {
            try {
                console.log('üîÑ Cargando temas...');
                console.log('üìä Estado del servidor: isServerOnline =', isServerOnline);

                if (!isServerOnline) {
                    console.log('‚ö†Ô∏è Servidor offline, cargando temas demo');
                    loadDemoTopics();
                    return;
                }

                console.log('üì° Llamando a /api/documents-status...');
                const response = await fetch(`${API_BASE}/api/documents-status`, {
                    credentials: 'include'
                });

                console.log('üì° Respuesta documents-status:', {
                    status: response.status,
                    ok: response.ok
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const status = await response.json();
                console.log('üì¶ Temas recibidos:', Object.keys(status).length);

                availableTopics = Object.entries(status).filter(([id, config]) =>
                    config.files && config.files.some(file => file.exists)
                );

                console.log('‚úÖ Temas disponibles filtrados:', availableTopics.length);
                populateTopicSelect();
                updateTopicInfo();

            } catch (error) {
                console.error('‚ùå Error cargando temas:', error);
                loadDemoTopics();
            }
        }

        function loadDemoTopics() {
            availableTopics = [
                ['demo-tema-14', { title: 'TEMA 14 - LOPJ (Demo)' }],
                ['demo-constitucional', { title: 'Derecho Constitucional (Demo)' }],
                ['demo-civil', { title: 'Procedimiento Civil (Demo)' }]
            ];
            
            populateTopicSelect();
            updateTopicInfo();
        }

        function populateTopicSelect() {
            const select = document.getElementById('topic-select');
            select.innerHTML = '<option value="">Selecciona un tema...</option>';
            
            availableTopics.forEach(([id, config]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = config.title;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                const startBtn = document.getElementById('start-btn');
                startBtn.disabled = !this.value;
            });
        }

        function updateTopicInfo() {
            const infoText = isServerOnline ? 
                `${availableTopics.length} temas disponibles` :
                `‚ö†Ô∏è Modo demostraci√≥n - ${availableTopics.length} temas de prueba`;
            
            document.getElementById('available-topics').innerHTML = 
                `<p style="text-align: center; color: ${isServerOnline ? '#6b7280' : '#dc2626'};">${infoText}</p>`;
        }

        // ========================
        // INICIO DEL ESTUDIO
        // ========================

        function startStudying() {
            const select = document.getElementById('topic-select');
            const selectedTopicId = select.value;
            
            if (!selectedTopicId) {
                showError('Por favor selecciona un tema');
                return;
            }
            
            currentTopic = selectedTopicId;
            
            const topicConfig = availableTopics.find(([id]) => id === selectedTopicId);
            const topicTitle = topicConfig ? topicConfig[1].title : 'Tema Demo';
            
            document.getElementById('current-topic-name').textContent = topicTitle;
            questionCount = 0;
            correctAnswers = 0;
            
            showQuestionMode();
            generateNextQuestion();
        }

        // ========================
        // GENERACI√ìN DE PREGUNTAS
        // ========================

        async function generateNextQuestion() {
            // SI ES MODO EXAMEN OFICIAL
            if (isOfficialExamMode && officialExamQuestions.length > 0) {
                // Si ya respondi√≥ todas las preguntas
                if (questionCount >= officialExamQuestions.length) {
                    finishOfficialExam(false); // false = no time out
                    return;
                }

                // Mostrar siguiente pregunta
                questionCount++;
                currentQuestion = officialExamQuestions[questionCount - 1];
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${officialExamQuestions.length}`;
                displayQuestion();
                return;
            }

            if (!currentTopic) return;

            // Si estamos en modo repaso, navegar por las preguntas del test
            if (window.isReviewMode && window.reviewQuestions) {
                window.currentReviewIndex++;

                // Si llegamos al final del test de repaso
                if (window.currentReviewIndex >= window.reviewQuestions.length) {
                    // Finalizar test de repaso
                    window.isReviewMode = false;
                    window.reviewQuestions = null;
                    window.currentReviewIndex = 0;

                    // Recargar preguntas falladas
                    await loadUserData();

                    // Volver a la p√°gina de repaso
                    alert(`¬°Test de repaso completado!\n\nAcertadas: ${correctAnswers} de ${questionCount}`);
                    backToTopicSelection();
                    showPage('review');
                    return;
                }

                // Mostrar siguiente pregunta de repaso
                currentQuestion = window.reviewQuestions[window.currentReviewIndex];
                questionCount++;
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${window.reviewQuestions.length}`;
                displayQuestion();
                return;
            }

            // Modo normal: generar pregunta desde la API
            questionCount++;
            document.getElementById('question-number').textContent = `Pregunta ${questionCount}`;

            showLoading();

            if (isServerOnline) {
                await generateQuestionWithRetry();
            } else {
                setTimeout(() => {
                    showDemoQuestion();
                }, 1000);
            }
        }

        function showDemoQuestion() {
            const demoQuestions = [
                {
                    question: "¬øCu√°l es el √≥rgano constitucional de gobierno del Poder Judicial?",
                    options: [
                        "A) El Consejo General del Poder Judicial (art. 122 CE)",
                        "B) El Ministerio de Justicia",
                        "C) El Tribunal Supremo",
                        "D) Las Audiencias Provinciales"
                    ],
                    correct: 0,
                    explanation: "La respuesta correcta es A. El art√≠culo 122 de la Constituci√≥n establece que el CGPJ es el √≥rgano de gobierno del Poder Judicial.",
                    difficulty: "media",
                    page_reference: "Art√≠culo 122 CE"
                },
                {
                    question: "Seg√∫n la Constituci√≥n, ¬øcu√°l es el principio fundamental de la administraci√≥n de justicia?",
                    options: [
                        "A) La justicia emana del pueblo y se administra por Jueces independientes (art. 117 CE)",
                        "B) Los jueces dependen del Gobierno",
                        "C) La justicia es administrada por las Comunidades Aut√≥nomas",
                        "D) Los tribunales est√°n subordinados al Parlamento"
                    ],
                    correct: 0,
                    explanation: "Correcto: A. El art√≠culo 117 CE establece que la justicia emana del pueblo y se administra por Jueces y Tribunales independientes.",
                    difficulty: "media",
                    page_reference: "Art√≠culo 117 CE"
                },
                {
                    question: "¬øCu√°l es el plazo general para interponer recurso de apelaci√≥n seg√∫n la LEC?",
                    options: [
                        "A) 10 d√≠as desde la notificaci√≥n",
                        "B) 20 d√≠as desde la notificaci√≥n",
                        "C) 15 d√≠as desde la notificaci√≥n",
                        "D) 30 d√≠as desde la notificaci√≥n"
                    ],
                    correct: 1,
                    explanation: "Correcto: B. El art√≠culo 458 LEC establece un plazo de 20 d√≠as para interponer recurso de apelaci√≥n.",
                    difficulty: "dif√≠cil",
                    page_reference: "Art√≠culo 458 LEC"
                }
            ];
            
            const randomIndex = Math.floor(Math.random() * demoQuestions.length);
            currentQuestion = demoQuestions[randomIndex];
            
            displayQuestion();
        }

        function displayQuestion() {
            document.getElementById('question-text').textContent = currentQuestion.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(index);
                
                optionDiv.innerHTML = `
                    <input type="radio" name="question-option" id="option-${index}" value="${index}">
                    <div class="option-text">${option}</div>
                `;
                
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'none';
        }

        function selectOption(optionIndex) {
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });
            
            const selectedOption = document.querySelectorAll('.option')[optionIndex];
            selectedOption.classList.add('selected');
            document.getElementById(`option-${optionIndex}`).checked = true;
            
            showResult(optionIndex);
        }

        async function showResult(userAnswer) {
            const isCorrect = userAnswer === currentQuestion.correct;

            if (isCorrect) correctAnswers++;

            // Detectar si estamos en modo repaso
            const isReview = window.isReviewMode === true;
            const questionId = isReview ? currentQuestion.id : null;

            // SI ES MODO EXAMEN OFICIAL
            if (isOfficialExamMode) {
                // Guardar respuesta en el array
                officialExamAnswers.push({
                    questionNumber: questionCount,
                    question: currentQuestion.question,
                    userAnswer,
                    correctAnswer: currentQuestion.correct,
                    isCorrect,
                    timestamp: Date.now()
                });

                // NO actualizar estad√≠sticas ni preguntas falladas en modo oficial
            } else {
                // MODO NORMAL O REPASO
                // Actualizar estad√≠sticas (o marcar como revisada si es repaso)
                await updateLocalStats(currentTopic, isCorrect, isReview, questionId);

                // Solo agregar a preguntas falladas si NO es modo repaso
                if (!isCorrect && !isReview) {
                    await addLocalFailedQuestion(currentTopic, currentQuestion, userAnswer);
                }
            }

            document.querySelectorAll('.option').forEach((opt, index) => {
                if (index === currentQuestion.correct) {
                    opt.classList.add('correct');
                } else if (index === userAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            const resultSection = document.getElementById('result-section');
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            const resultExplanation = document.getElementById('result-explanation');

            if (isCorrect) {
                resultSection.className = 'result-section correct';
                resultIcon.textContent = '‚úÖ';
                resultTitle.textContent = isReview ? '¬°Correcto! Pregunta eliminada del repaso.' : '¬°Correcto!';
                resultTitle.style.color = '#16a34a';
            } else {
                resultSection.className = 'result-section incorrect';
                resultIcon.textContent = '‚ùå';
                resultTitle.textContent = isReview ? 'Incorrecto. Seguir√°s viendo esta pregunta.' : 'Incorrecto';
                resultTitle.style.color = '#dc2626';
            }

            resultExplanation.textContent = currentQuestion.explanation;
            resultSection.style.display = 'block';

            document.getElementById('next-question-btn').style.display = 'block';
        }

        // ========================
        // ESTAD√çSTICAS
        // ========================

        function displayStats() {
            const container = document.getElementById('stats-container');
            
            if (Object.keys(userStats).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üìà</div>
                        <h3>¬°Comienza a estudiar!</h3>
                        <p>Aqu√≠ ver√°s tus estad√≠sticas una vez que respondas algunas preguntas.</p>
                    </div>
                `;
                return;
            }
            
            let statsHTML = '<div class="stats-grid">';
            
            Object.entries(userStats).forEach(([topicId, stats]) => {
                const accuracy = stats.accuracy || 0;
                const badgeClass = accuracy >= 80 ? 'good' : accuracy >= 60 ? 'warning' : 'danger';
                const lastStudied = new Date(stats.lastStudied).toLocaleDateString('es-ES');
                
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">${stats.title}</div>
                            <div class="stat-badge ${badgeClass}">${accuracy}%</div>
                        </div>
                        <div class="stat-numbers">
                            <div class="stat-number">
                                <div class="value">${stats.totalQuestions}</div>
                                <div class="label">Preguntas</div>
                            </div>
                            <div class="stat-number">
                                <div class="value">${stats.correctAnswers}</div>
                                <div class="label">Correctas</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${badgeClass}" style="width: ${accuracy}%"></div>
                        </div>
                        <div class="last-studied">√öltimo estudio: ${lastStudied}</div>
                    </div>
                `;
            });
            
            statsHTML += '</div>';
            container.innerHTML = statsHTML;
        }

        // ========================
        // PREGUNTAS FALLADAS
        // ========================

        function displayFailedQuestions() {
            const container = document.getElementById('failed-container');

            if (Object.keys(failedQuestions).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üéØ</div>
                        <h3>¬°Excelente!</h3>
                        <p>No tienes preguntas falladas para repasar.</p>
                    </div>
                `;
                return;
            }

            let failedHTML = '<div class="failed-topics">';

            Object.entries(failedQuestions).forEach(([topicId, topicData]) => {
                const topicTitle = topicData.title || 'Tema';
                const questionCount = topicData.questions.length;

                failedHTML += `
                    <div class="failed-topic-card" style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #f3f4f6;">
                        <div style="margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: #1f2937; font-size: 1.25rem;">${topicTitle}</h3>
                            <div style="color: #dc2626; font-weight: 600; font-size: 0.875rem;">
                                üìù ${questionCount} pregunta${questionCount !== 1 ? 's' : ''} para repasar
                            </div>
                        </div>
                        <button onclick="startReviewTest('${topicId}')" style="width: 100%; background: #f97316; color: white; padding: 14px 24px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease;" onmouseover="this.style.background='#ea580c'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(249, 115, 22, 0.3)';" onmouseout="this.style.background='#f97316'; this.style.transform='none'; this.style.boxShadow='none';">
                            üéØ Hacer Test de Repaso
                        </button>
                    </div>
                `;
            });

            failedHTML += '</div>';
            container.innerHTML = failedHTML;
        }

        // Nueva funci√≥n: Iniciar test de repaso
        async function startReviewTest(topicId) {
            try {
                console.log(`üéØ Iniciando test de repaso para tema: ${topicId}`);

                const response = await fetch(`${API_BASE}/api/review-exam/${topicId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al cargar preguntas de repaso');
                }

                const data = await response.json();

                // Iniciar el test con las preguntas de repaso
                currentTopic = topicId;
                window.reviewQuestions = data.questions;
                window.isReviewMode = true;
                window.currentReviewIndex = 0;

                currentQuestion = window.reviewQuestions[0];
                questionCount = 1;
                correctAnswers = 0;

                // Obtener el t√≠tulo del tema
                const topicConfig = availableTopics.find(([id]) => id === topicId);
                const topicTitle = topicConfig ? topicConfig[1].title : (failedQuestions[topicId]?.title || 'Test de Repaso');

                document.getElementById('current-topic-name').textContent = topicTitle + ' - REPASO';
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${window.reviewQuestions.length}`;

                // Mostrar p√°gina de estudio y el contenedor de preguntas
                showPage('study');
                showQuestionMode();
                displayQuestion();

                console.log(`‚úÖ Test de repaso iniciado: ${data.questions.length} preguntas`);

            } catch (error) {
                console.error('Error iniciando test de repaso:', error);
                alert('Error al cargar el test de repaso. Intenta de nuevo.');
            }
        }

        // ========================
        // UTILIDADES
        // ========================

        function showLoading() {
            document.getElementById('question-text').innerHTML = 
                `<div style="text-align: center; padding: 20px;">
                    <div class="loading"></div>
                    <p style="margin-top: 12px; color: #6b7280;">Generando pregunta...</p>
                </div>`;
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('next-question-btn').style.display = 'none';
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        function clearAllData() {
            if (confirm('¬øBorrar todos los datos de progreso?')) {
                localStorage.removeItem('oposicion_stats');
                localStorage.removeItem('oposicion_failed');
                userStats = {};
                failedQuestions = {};
                
                displayStats();
                displayFailedQuestions();
                
                showSuccess('Datos eliminados');
            }
        }

        // ========================
        // EXAMEN OFICIAL
        // ========================

        function selectExamSize(size) {
            officialExamConfig.questionCount = size;
            document.querySelectorAll('.exam-size-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.size) === size) {
                    btn.classList.add('active');
                }
            });
        }

        function selectExamTime(minutes) {
            officialExamConfig.timeLimit = minutes;
            document.querySelectorAll('.exam-time-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.time) === minutes) {
                    btn.classList.add('active');
                }
            });
        }

        async function startOfficialExam() {
            try {
                console.log(`üéì Iniciando examen oficial: ${officialExamConfig.questionCount} preguntas, ${officialExamConfig.timeLimit} minutos`);

                // Mostrar loading
                showLoading();

                // Solicitar examen al servidor
                const response = await fetch(`${API_BASE}/api/exam/official`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionCount: officialExamConfig.questionCount
                    })
                });

                if (response.status === 401 || response.status === 403) {
                    isAuthenticated = false;
                    currentUser = null;
                    showAuthScreen();
                    showAuthMessage('error', 'Sesi√≥n expirada. Inicia sesi√≥n nuevamente.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al generar examen oficial');
                }

                const data = await response.json();

                // Configurar examen
                officialExamQuestions = data.questions;
                isOfficialExamMode = true;
                officialExamStartTime = Date.now();
                officialExamAnswers = [];
                questionCount = 1;
                correctAnswers = 0;
                currentQuestion = officialExamQuestions[0];

                // Iniciar temporizador
                officialExamTimeRemaining = officialExamConfig.timeLimit * 60; // convertir a segundos
                startOfficialExamTimer();

                // Mostrar primera pregunta
                showPage('study');
                showQuestionMode();
                document.getElementById('current-topic-name').textContent = 'üéì EXAMEN OFICIAL';
                document.getElementById('question-number').textContent = `Pregunta ${questionCount} de ${officialExamQuestions.length}`;
                displayQuestion();

                console.log(`‚úÖ Examen oficial iniciado: ${officialExamQuestions.length} preguntas`);

            } catch (error) {
                console.error('Error iniciando examen oficial:', error);
                alert('Error al generar examen oficial. Intenta de nuevo.');
                hideLoading();
            }
        }

        function startOfficialExamTimer() {
            const timerElement = document.getElementById('official-exam-timer');
            timerElement.style.display = 'block';

            // Actualizar cada segundo
            officialExamTimer = setInterval(() => {
                officialExamTimeRemaining--;

                updateOfficialExamTimer();

                // Si se acaba el tiempo
                if (officialExamTimeRemaining <= 0) {
                    stopOfficialExamTimer();
                    finishOfficialExam(true); // true = tiempo agotado
                }
            }, 1000);
        }

        function updateOfficialExamTimer() {
            const minutes = Math.floor(officialExamTimeRemaining / 60);
            const seconds = officialExamTimeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('timer-display').textContent = display;

            const timerElement = document.getElementById('official-exam-timer');

            // Cambiar estilo seg√∫n tiempo restante
            if (officialExamTimeRemaining <= 60) {
                // Menos de 1 minuto - DANGER (rojo parpadeante)
                timerElement.className = 'danger';
            } else if (officialExamTimeRemaining <= 300) {
                // Menos de 5 minutos - WARNING (amarillo)
                timerElement.className = 'warning';
            } else {
                timerElement.className = '';
            }
        }

        function stopOfficialExamTimer() {
            if (officialExamTimer) {
                clearInterval(officialExamTimer);
                officialExamTimer = null;
            }
            document.getElementById('official-exam-timer').style.display = 'none';
        }

        async function finishOfficialExam(timeOut = false) {
            stopOfficialExamTimer();

            const totalQuestions = officialExamQuestions.length;
            const answeredQuestions = officialExamAnswers.length;
            const correctCount = officialExamAnswers.filter(a => a.isCorrect).length;
            const nota = (correctCount / totalQuestions) * 10;
            const timeSpent = Math.floor((Date.now() - officialExamStartTime) / 1000);

            // Mostrar resultados
            const resultHTML = `
                <div class="card" style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">
                        ${nota >= 5 ? 'üéâ' : 'üìö'}
                    </div>
                    <h2 style="margin-bottom: 8px;">
                        ${timeOut ? '‚è±Ô∏è Tiempo Agotado' : '‚úÖ Examen Finalizado'}
                    </h2>
                    <div style="font-size: 3rem; font-weight: bold; color: ${nota >= 5 ? '#16a34a' : '#dc2626'}; margin: 24px 0;">
                        ${nota.toFixed(2)} / 10
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 32px 0; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #16a34a;">${correctCount}</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Correctas</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${totalQuestions - correctCount}</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Incorrectas</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #f97316;">${totalQuestions}</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Total</div>
                        </div>
                    </div>
                    <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin: 24px 0;">
                        <div style="font-weight: 600; margin-bottom: 8px;">üìä Estad√≠sticas</div>
                        <div style="display: flex; justify-content: space-around; font-size: 0.875rem; color: #6b7280;">
                            <div>Tiempo: ${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}</div>
                            <div>Precisi√≥n: ${((correctCount / totalQuestions) * 100).toFixed(1)}%</div>
                            <div>Preguntas: ${totalQuestions}</div>
                        </div>
                    </div>
                    <button onclick="exitOfficialExam()" style="width: 100%; background: #f97316; color: white; padding: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 1.125rem;">
                        üè† Volver al Inicio
                    </button>
                </div>
            `;

            document.getElementById('topic-selection').style.display = 'none';
            document.getElementById('question-container').innerHTML = resultHTML;
            document.getElementById('question-container').classList.remove('hidden');

            // Resetear variables
            isOfficialExamMode = false;
            officialExamQuestions = [];
            officialExamAnswers = [];
            officialExamTimeRemaining = 0;
        }

        function exitOfficialExam() {
            isOfficialExamMode = false;
            officialExamQuestions = [];
            officialExamAnswers = [];
            stopOfficialExamTimer();
            showPage('official-exam');
        }

        // ========================
        // INICIALIZACI√ìN
        // ========================

        window.onload = async function() {
            console.log('üöÄ Iniciando aplicaci√≥n...');

            // Primero verificar autenticaci√≥n
            const authenticated = await checkAuth();

            if (authenticated) {
                // Solo cargar la app si est√° autenticado
                await checkServerHealth();
                await loadUserData();
                showPage('study');
                console.log('‚úÖ Aplicaci√≥n iniciada');
            } else {
                console.log('‚è≥ Esperando autenticaci√≥n...');
            }
        };
    </script>
</body>
</html>